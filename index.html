<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Generador de Patrón - Chaleco (Exportable .html/.svg)</title>
  <style>
    :root{--panel-w:320px;--bg:#f6f7fb;--card:#fff}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{display:flex;gap:18px;background:linear-gradient(180deg,#f3f5fa, #eef2fb);padding:18px}
    .controls{width:var(--panel-w);background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,30,60,0.08)}
    h1{font-size:18px;margin:0 0 8px}
    label{display:block;font-size:13px;color:#333;margin-top:10px}
    input[type=number], input[type=range], select{width:100%;padding:6px;border-radius:8px;border:1px solid #e1e6f2;background:#fbfcff}
    .small{font-size:12px;color:#666}
    .canvas-wrap{flex:1;display:flex;flex-direction:column;gap:12px}
    .viewer{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,30,60,0.06);display:flex;gap:12px}
    svg{width:100%;height:720px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:8px}
    .row{display:flex;gap:8px;margin-top:12px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#1543ff;color:white;cursor:pointer}
    .muted{background:transparent;color:#1543ff;border:1px solid #d6e0ff}
    .checkbox{display:flex;gap:8px;align-items:center;margin-top:8px}
    .footer-note{font-size:12px;color:#666;margin-top:10px}
    .tips{font-size:13px;color:#222;margin-top:8px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid #eef3ff}
    .inline{display:inline-block}
  </style>
</head>
<body>
  <div class="controls">
    <h1>Generador de patrón — Chaleco (Hombre)</h1>
    <div class="small">Introduce tus medidas en centímetros. El patrón se redibuja automáticamente.</div>

    <label>Contorno de pecho (A)</label>
    <input id="pecho" type="number" min="60" max="160" value="100">

    <label>Contorno cintura (B)</label>
    <input id="cintura" type="number" min="60" max="150" value="90">

    <label>Ancho espalda (C)</label>
    <input id="espalda" type="number" min="30" max="60" value="42">

    <label>Largo total prenda (D)</label>
    <input id="largo" type="number" min="40" max="90" value="60">

    <label>Largo sisa (E)</label>
    <input id="sisa" type="number" min="18" max="35" value="25">

    <label>Ancho hombros (F)</label>
    <input id="hombros" type="number" min="30" max="60" value="46">

    <label>Profundidad escote delantero (G)</label>
    <input id="escote" type="number" min="6" max="20" value="10">

    <label>Margen de costura (en cm)</label>
    <input id="margen" type="number" min="0" max="3" step="0.1" value="1.5">

    <div class="checkbox"><input id="mirror" type="checkbox" checked><label for="mirror" class="small inline">Dibujar mitad + espejo (simetría)</label></div>
    <div class="checkbox"><input id="showMargins" type="checkbox" checked><label for="showMargins" class="small inline">Mostrar margen de costura</label></div>

    <div class="row">
      <button id="downloadSVG">Descargar SVG</button>
      <button id="downloadPNG" class="muted">Descargar PNG</button>
    </div>
    <div class="row">
      <button id="downloadHTML" class="muted">Descargar HTML (archivo)</button>
      <button id="printBtn" class="muted">Imprimir (tamaño real)</button>
    </div>

    <div class="tips">
      <strong>Consejos:</strong>
      <ul>
        <li>Las curvas (sisa/escote) están aproximadas con curvas Bézier y medidas estándar; puedes ajustar valores para afinar.</li>
        <li>Para impresión a escala real, abre el SVG descargado en un visor y selecciona 100% / sin ajuste de escala.</li>
      </ul>
    </div>

    <div class="footer-note">Hecho por tu compadre — Si quieres añadir pinzas, bolsillos o descarga DXF me dices y lo implemento.</div>
  </div>

  <div class="canvas-wrap">
    <div class="viewer">
      <svg id="svg" viewBox="0 0 800 1000" xmlns="http://www.w3.org/2000/svg" ></svg>
    </div>
  </div>

<script>
(function(){
  // Utilidades
  const $ = id => document.getElementById(id);
  const svg = $('svg');

  function mmToPx(mm){ return mm * (96/25.4); } // approx but we'll work in cm -> px scale custom

  // Escalado: 1 cm => scale px (calculado dinámicamente para encajar)
  const baseOffset = {x:80,y:80};

  function getValues(){
    return {
      pecho: parseFloat($('pecho').value),
      cintura: parseFloat($('cintura').value),
      espalda: parseFloat($('espalda').value),
      largo: parseFloat($('largo').value),
      sisa: parseFloat($('sisa').value),
      hombros: parseFloat($('hombros').value),
      escote: parseFloat($('escote').value),
      margen: parseFloat($('margen').value),
      mirror: $('mirror').checked,
      showMargins: $('showMargins').checked
    }
  }

  // Convertir medidas cm -> px (escala basada en canvas)
  function calcScale(vals){
    // queremos que el largo máximo del patrón ocupe ~700px
    const maxCm = Math.max(vals.largo + 10, vals.hombros/2 + vals.pecho/4 + 10);
    const scale = 700 / maxCm;
    return scale; // px per cm
  }

  // Dibuja patrón delantero usando puntos paramétricos y Bézier
  function buildFrontPath(vals, scale){
    // Base de puntos en cm
    const cx = baseOffset.x;
    const cy = baseOffset.y;

    // P0: punto en centro cuello (0,0)
    const P0 = {x: cx, y: cy};
    // P1: hombro (hombros/2, 0)
    const P1 = {x: cx + (vals.hombros/2)*scale, y: cy};
    // P2: punto linal sisa (hombro vertical sisa)
    const P2 = {x: P1.x, y: cy + vals.sisa*scale};
    // P3: costado en cintura (pecho/4, largo)
    const P3 = {x: cx + (vals.pecho/4)*scale, y: cy + vals.largo*scale};
    // P4: escote centro delantero
    const P4 = {x: cx, y: cy + vals.escote*scale};

    // Control para curva de escote: ligeramente hacia la derecha
    const C_neck = {x: cx + 0.5*scale, y: cy + (vals.escote/2)*scale};

    // Control para curva de hombro -> sisa
    const C_sh1 = {x: P1.x - 8*scale, y: P1.y + 6*scale};
    const C_sh2 = {x: P2.x - 6*scale, y: P2.y - 6*scale};

    // Curva de sisa: control intermedio hacia interior
    const C_aisle1 = {x: P2.x - 12*scale, y: P2.y + 8*scale};
    const C_aisle2 = {x: P3.x + 6*scale, y: P3.y - 18*scale};

    // Montar path SVG (mitad delantera desde centro cuello -> hombro -> sisa -> cintura -> centro delantero)
    const path = [];
    path.push(`M ${P0.x.toFixed(2)} ${P0.y.toFixed(2)}`);
    // Escote (cuadrática -> usar cúbica con control C_neck)
    path.push(`C ${C_neck.x.toFixed(2)} ${C_neck.y.toFixed(2)} ${C_neck.x.toFixed(2)} ${C_neck.y.toFixed(2)} ${P4.x.toFixed(2)} ${P4.y.toFixed(2)}`);
    // Línea centro delantero hasta cintura
    path.push(`L ${P3.x.toFixed(2)} ${P3.y.toFixed(2)}`);
    // Curva costado / sisa
    path.push(`C ${C_aisle2.x.toFixed(2)} ${C_aisle2.y.toFixed(2)} ${C_aisle1.x.toFixed(2)} ${C_aisle1.y.toFixed(2)} ${P2.x.toFixed(2)} ${P2.y.toFixed(2)}`);
    // Curva hombro
    path.push(`C ${C_sh2.x.toFixed(2)} ${C_sh2.y.toFixed(2)} ${C_sh1.x.toFixed(2)} ${C_sh1.y.toFixed(2)} ${P1.x.toFixed(2)} ${P1.y.toFixed(2)}`);
    // Volver al cuello (línea imaginaria superior)
    path.push(`L ${P0.x.toFixed(2)} ${P0.y.toFixed(2)}`);

    return {d: path.join(' '), points:{P0,P1,P2,P3,P4}};
  }

  // Generar la parte espalda (más recta, sin escote pronunciado)
  function buildBackPath(vals, scale){
    const cx = baseOffset.x + 280; // separar la espalda a la derecha
    const cy = baseOffset.y;
    const P0 = {x: cx, y: cy};
    const P1 = {x: cx + (vals.hombros/2)*scale, y: cy};
    const P2 = {x: cx + (vals.espalda/2)*scale, y: cy + vals.sisa*scale};
    const P3 = {x: cx + (vals.pecho/4 + 2)*scale, y: cy + vals.largo*scale};
    const P4 = {x: cx, y: cy + (vals.escote*0.6)*scale};

    const C_sh1 = {x: P1.x - 8*scale, y: P1.y + 6*scale};
    const C_sh2 = {x: P2.x - 6*scale, y: P2.y - 6*scale};
    const C_aisle1 = {x: P2.x - 12*scale, y: P2.y + 8*scale};
    const C_aisle2 = {x: P3.x + 6*scale, y: P3.y - 18*scale};

    const path = [];
    path.push(`M ${P0.x.toFixed(2)} ${P0.y.toFixed(2)}`);
    path.push(`L ${P1.x.toFixed(2)} ${P1.y.toFixed(2)}`);
    path.push(`C ${C_sh2.x.toFixed(2)} ${C_sh2.y.toFixed(2)} ${C_sh1.x.toFixed(2)} ${C_sh1.y.toFixed(2)} ${P2.x.toFixed(2)} ${P2.y.toFixed(2)}`);
    path.push(`C ${C_aisle2.x.toFixed(2)} ${C_aisle2.y.toFixed(2)} ${C_aisle1.x.toFixed(2)} ${C_aisle1.y.toFixed(2)} ${P3.x.toFixed(2)} ${P3.y.toFixed(2)}`);
    path.push(`L ${P4.x.toFixed(2)} ${P4.y.toFixed(2)}`);
    path.push(`L ${P0.x.toFixed(2)} ${P0.y.toFixed(2)}`);

    return {d: path.join(' '), points:{P0,P1,P2,P3,P4}};
  }

  // Crear path de margen aproximado (usando stroke como margen visual). For a proper offset path you'd need complex geometry (not implemented here).
  function render(){
    const vals = getValues();
    const scale = calcScale(vals);

    // limpiar svg
    while(svg.firstChild) svg.removeChild(svg.firstChild);

    // fondo cuadriculado ligero
    const grid = document.createElementNS(svg.namespaceURI,'g');
    svg.appendChild(grid);
    const viewW = 800, viewH = 1000;
    for(let x=0;x<viewW;x+=40){
      const line = document.createElementNS(svg.namespaceURI,'line');
      line.setAttribute('x1',x);line.setAttribute('y1',0);line.setAttribute('x2',x);line.setAttribute('y2',viewH);line.setAttribute('stroke','#f3f6ff');line.setAttribute('stroke-width','0.6');grid.appendChild(line);
    }

    // Front
    const front = buildFrontPath(vals, scale);
    const frontPath = document.createElementNS(svg.namespaceURI,'path');
    frontPath.setAttribute('d', front.d);
    frontPath.setAttribute('fill','none');
    frontPath.setAttribute('stroke','#0b2a66');
    frontPath.setAttribute('stroke-width',2);
    frontPath.setAttribute('id','frontPath');
    svg.appendChild(frontPath);

    // Back
    const back = buildBackPath(vals, scale);
    const backPath = document.createElementNS(svg.namespaceURI,'path');
    backPath.setAttribute('d', back.d);
    backPath.setAttribute('fill','none');
    backPath.setAttribute('stroke','#1a6b2b');
    backPath.setAttribute('stroke-width',2);
    backPath.setAttribute('id','backPath');
    svg.appendChild(backPath);

    // Dibujar puntos guía y medidas
    function addPoint(p,label){
      const c = document.createElementNS(svg.namespaceURI,'circle');
      c.setAttribute('cx',p.x);c.setAttribute('cy',p.y);c.setAttribute('r',3);c.setAttribute('fill','#334');svg.appendChild(c);
      if(label){
        const t = document.createElementNS(svg.namespaceURI,'text');
        t.setAttribute('x',p.x+6);t.setAttribute('y',p.y+4);t.setAttribute('font-size',10);t.setAttribute('fill','#223');t.textContent=label;svg.appendChild(t);
      }
    }

    // añadir etiquetas front
    const fp = front.points; addPoint(fp.P0,'C. Cuello'); addPoint(fp.P1,'Hombro'); addPoint(fp.P2,'Sisa'); addPoint(fp.P3,'Cintura'); addPoint(fp.P4,'Escote');
    const bp = back.points; addPoint(bp.P0,'Esp Cuello'); addPoint(bp.P1,'Hombro'); addPoint(bp.P2,'Sisa'); addPoint(bp.P3,'Cintura');

    // Mostrar margen de costura como otra ruta (simulación) - utilizando stroke más grueso y opacidad
    const showMargins = vals.showMargins;
    if(showMargins){
      const frontMargin = frontPath.cloneNode(true);
      frontMargin.setAttribute('stroke','#ff5a5a');
      frontMargin.setAttribute('stroke-opacity','0.18');
      frontMargin.setAttribute('stroke-width', Math.max( (vals.margen*scale)*2 , 6));
      svg.insertBefore(frontMargin, frontPath);

      const backMargin = backPath.cloneNode(true);
      backMargin.setAttribute('stroke','#ff5a5a');
      backMargin.setAttribute('stroke-opacity','0.18');
      backMargin.setAttribute('stroke-width', Math.max( (vals.margen*scale)*2 , 6));
      svg.insertBefore(backMargin, backPath);
    }

    // Texto de medidas
    const meta = document.createElementNS(svg.namespaceURI,'text');
    meta.setAttribute('x',20);meta.setAttribute('y',950);meta.setAttribute('font-size',12);meta.setAttribute('fill','#334');
    meta.textContent = `Pecho ${vals.pecho} cm — Cintura ${vals.cintura} cm — Hombros ${vals.hombros} cm — Largo ${vals.largo} cm — Margen ${vals.margen} cm`;
    svg.appendChild(meta);

  }

  // Eventos
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', render));
  render();

  // Exportar SVG
  function download(filename, content){
    const a = document.createElement('a');
    a.href = content;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  $('downloadSVG').addEventListener('click', ()=>{
    const serializer = new XMLSerializer();
    const s = serializer.serializeToString(svg);
    const header = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n';
    const blob = new Blob([header,s], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    download('patron_chaleco.svg', url);
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  });

  // Export PNG rasterizando SVG en canvas
  $('downloadPNG').addEventListener('click', ()=>{
    const serializer = new XMLSerializer();
    const s = serializer.serializeToString(svg);
    const svgBlob = new Blob([s], {type: 'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement('canvas');
      canvas.width = 2400; canvas.height = 3000; // alta resolución
      const ctx = canvas.getContext('2d');
      // fondo blanco
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
      // dibujar
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(function(blob){
        const pUrl = URL.createObjectURL(blob);
        download('patron_chaleco.png', pUrl);
        setTimeout(()=>URL.revokeObjectURL(pUrl),2000);
      }, 'image/png');
      URL.revokeObjectURL(url);
    };
    img.src = url;
  });

  // Descargar HTML (archivo con este mismo código) — generamos un archivo básico que incluye el SVG actual embebido
  $('downloadHTML').addEventListener('click', ()=>{
    const serializer = new XMLSerializer();
    const s = serializer.serializeToString(svg);
    const html = `<!doctype html>\n<html><head><meta charset=\"utf-8\"><title>Patrón Chaleco Exportado</title></head><body>\n<h3>Patrón exportado</h3>\n<div>${s}</div>\n</body></html>`;
    const blob = new Blob([html], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    download('patron_chaleco_export.html', url);
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  });

  // Imprimir a tamaño real (abre una nueva ventana con el SVG y llama a print)
  $('printBtn').addEventListener('click', ()=>{
    const serializer = new XMLSerializer();
    const s = serializer.serializeToString(svg);
    const win = window.open('','Patrón');
    win.document.write('<html><head><title>Imprimir Patrón</title><meta charset="utf-8"></head><body>');
    win.document.write('<div style="transform-origin: top left;">'+s+'</div>');
    win.document.write('</body></html>');
    win.document.close();
    setTimeout(()=>win.print(),500);
  });

})();
</script>
</body>
</html>
